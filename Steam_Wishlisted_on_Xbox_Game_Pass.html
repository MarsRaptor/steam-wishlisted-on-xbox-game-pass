<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Steam Wishlisted on Xbox Game Pass</title>
    <meta name="author" content="MarsRaptor">
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <script>
        /**
         * FuzzySet 
         * Licence     : https://github.com/Glench/fuzzyset.js/blob/master/LICENSE.md
         * Contributor : Glen Chiacchieri
         * Source Code : http://github.com/Glench/fuzzyset.js
         */
        /**
         * Minified by jsDelivr using Terser v5.3.5.
         * Original file: /npm/fuzzyset@1.0.6/dist/fuzzyset.js
         *
         * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
         */
        var FuzzySet = function () { "use strict"; return function (t, r, e, n) { var i = {}; t = t || [], i.gramSizeLower = e || 2, i.gramSizeUpper = n || 3, i.useLevenshtein = "boolean" != typeof r || r, i.exactSet = {}, i.matchDict = {}, i.items = {}; var a = function (t, r) { if (null === t && null === r) throw "Trying to compare two null values"; if (null === t || null === r) return 0; var e = function (t, r) { for (var e, n, i = [], a = 0; a <= r.length; a++)for (var h = 0; h <= t.length; h++)n = a && h ? t.charAt(h - 1) === r.charAt(a - 1) ? e : Math.min(i[h], i[h - 1], e) + 1 : a + h, e = i[h], i[h] = n; return i.pop() }(t = String(t), r = String(r)); return t.length > r.length ? 1 - e / t.length : 1 - e / r.length }, h = /[^a-zA-Z0-9\u00C0-\u00FF, ]+/g, o = function (t, r) { for (var e = {}, n = function (t, r) { r = r || 2; var e = "-" + t.toLowerCase().replace(h, "") + "-", n = r - e.length, i = []; if (n > 0) for (var a = 0; a < n; ++a)e += "-"; for (a = 0; a < e.length - r + 1; ++a)i.push(e.slice(a, a + r)); return i }(t, r = r || 2), i = 0; i < n.length; ++i)n[i] in e ? e[n[i]] += 1 : e[n[i]] = 1; return e }; i.get = function (t, r, e) { void 0 === e && (e = .33); var n = this._get(t, e); return n || void 0 === r ? n : r }, i._get = function (t, r) { for (var e = [], n = this.gramSizeUpper; n >= this.gramSizeLower; --n)if ((e = this.__get(t, n, r)) && e.length > 0) return e; return null }, i.__get = function (t, r, e) { var n, i, h, s, u = this._normalizeStr(t), c = {}, f = o(u, r), l = this.items[r], g = 0; for (n in f) if (i = f[n], g += Math.pow(i, 2), n in this.matchDict) for (d = 0; d < this.matchDict[n].length; ++d)h = this.matchDict[n][d][0], s = this.matchDict[n][d][1], h in c ? c[h] += i * s : c[h] = i * s; if (function (t) { for (var r in t) if (t.hasOwnProperty(r)) return !1; return !0 }(c)) return null; var v, m = Math.sqrt(g), p = []; for (var S in c) v = c[S], p.push([v / (m * l[S][0]), l[S][1]]); var z = function (t, r) { return t[0] < r[0] ? 1 : t[0] > r[0] ? -1 : 0 }; if (p.sort(z), this.useLevenshtein) { for (var w = [], _ = Math.min(50, p.length), d = 0; d < _; ++d)w.push([a(p[d][1], u), p[d][1]]); (p = w).sort(z) } return w = [], p.forEach(function (t) { t[0] >= e && w.push([t[0], this.exactSet[t[1]]]) }.bind(this)), w }, i.add = function (t) { if (this._normalizeStr(t) in this.exactSet) return !1; for (var r = this.gramSizeLower; r < this.gramSizeUpper + 1; ++r)this._add(t, r) }, i._add = function (t, r) { var e = this._normalizeStr(t), n = this.items[r] || [], i = n.length; n.push(0); var a, h, s = o(e, r), u = 0; for (a in s) h = s[a], u += Math.pow(h, 2), a in this.matchDict ? this.matchDict[a].push([i, h]) : this.matchDict[a] = [[i, h]]; var c = Math.sqrt(u); n[i] = [c, e], this.items[r] = n, this.exactSet[e] = t }, i._normalizeStr = function (t) { if ("[object String]" !== Object.prototype.toString.call(t)) throw "Must use a string as argument to FuzzySet functions"; return t.toLowerCase() }, i.length = function () { var t, r = 0; for (t in this.exactSet) this.exactSet.hasOwnProperty(t) && (r += 1); return r }, i.isEmpty = function () { for (var t in this.exactSet) if (this.exactSet.hasOwnProperty(t)) return !1; return !0 }, i.values = function () { var t, r = []; for (t in this.exactSet) this.exactSet.hasOwnProperty(t) && r.push(this.exactSet[t]); return r }; for (var s = i.gramSizeLower; s < i.gramSizeUpper + 1; ++s)i.items[s] = []; for (s = 0; s < t.length; ++s)i.add(t[s]); return i } }();
    </script>
</head>

<body>

    <header>
        <div class="search">
            <input type="text" placeholder="Steam username" id="steam_user" autofocus>
            <button type="button" id="search_button"
                onclick="window.location.hash = document.getElementById('steam_user').value">Find
                Steam
                wishlisted on Xbox Game Pass</button>
        </div>
        <div id="message_container">
            <div>
                <h2 id="info"></h2>
            </div>
            <div>
                <h2 id="errors"></h2>
            </div>
        </div>
    </header>
    <main>
        <div id="wishlisted"></div>
        <div>
            <h1>Are games on your Steam wishlist also on Xbox Game Pass ?</h1>
            <h2>Find out by typing the desired Steam username into
                the search bar and clicking on the "<em>Find Steam wishlisted on Xbox Game Pass</em>" button!</h2>
            <p>
                Once a search has been made you can bookmark the page to circumvent typing the username everytime.<br>
                Just make sure that the URL ends with <em>#&lt;username&gt;</em>
            </p>
            <br>
            <h2>Idea and portions of logic by <a href="https://github.com/geeseven">geeseven</a></h2><br>
        </div>
    </main>

    <footer>
        <details>
            <summary>THIRD PARTY COMPONENTS</summary>
            <h4><a href="https://www.pcgamingwiki.com/wiki/List_of_Xbox_Game_Pass_games">pcgamingwiki</a></h4>
            <h4><a href="https://store.steampowered.com/">Steam Store</a> API by <a
                    href="https://store.steampowered.com/legal/?snr=1_44_44_">Valve Corporation</a></h4>
            <h4><a href="http://github.com/Glench/fuzzyset.js">fuzzyset.js</a> by <a
                    href="https://github.com/Glench/">Glen
                    Chiacchieri</a> used under <a
                    href="https://github.com/Glench/fuzzyset.js/blob/master/LICENSE.md">The
                    Prosperity Public License 3.0.0</a></h4>            
        </details>
        <br>
        <details>
            <summary>DISCLAIMER</summary>
            <p>
                THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT
                LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
                NO
                EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
                WHETHER IN
                AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
                USE
                OR OTHER DEALINGS IN THE SOFTWARE.
            </p>
        </details>
        <br>
        <details>
            <summary>Copyright (C) 2020 <a href="https://github.com/MarsRaptor">MarsRaptor</a> under "THE
                    BEERWARE LICENSE" (Revision 42)</summary>
            <p>
                https://github.com/MarsRaptor wrote this code. As long as you retain this
                notice, you can do whatever you want with this stuff. If we
                meet someday, and you think this stuff is worth it, you can
                buy me a beer in return, MarsRaptor.
            </p>
        </details>
        <p>

        </p>
    </footer>
    <script>

        /*
        * ------------------------------------------------------------
        * "THE BEERWARE LICENSE" (Revision 42):
        * https://github.com/MarsRaptor wrote this code. As long as you retain this 
        * notice, you can do whatever you want with this stuff. If we
        * meet someday, and you think this stuff is worth it, you can
        * buy me a beer in return, MarsRaptor.
        * ------------------------------------------------------------
        */
        //=========================================================================
        // FUZZY SEARCH CONFIGURATION
        //=========================================================================
        const MIN_MATCH_SCORE = 0.8; // info : http://github.com/Glench/fuzzyset.js 
        //=========================================================================

        async function steam_wishlist(user) {
            const wishlist_json = {}
            let page = 0
            let pages_left = true;
            while (pages_left) {
                const fetch_url = `https://store.steampowered.com/wishlist/id/${user}/wishlistdata/?p=${page++}`;

                try {
                    const wishlist_page = await (await fetch(fetch_url)).json();

                    if (Array.isArray(wishlist_page)) {
                        pages_left = false;
                        continue;
                    }
                    if (typeof wishlist_page["success"] !== "undefined") {
                        throw "Could not load Steam wishlist. Check in privacy settings that Game details are set to public for this user.";
                    }

                    Object.assign(wishlist_json, wishlist_page);

                } catch (error) {
                    console.error(error);
                    throw "Could not load Steam wishlist. Check in privacy settings that Game details are set to public for this user.";
                }


            }
            return wishlist_json;
        }

        async function pggamingwikiListOfXboxGamePassgames() {
            const regex = /(?<=<th[^>]+table-xbox-body-game[^>]+><a[^>]+title=")(.*)(?=")/gm;
            const fetch_url = `https://www.pcgamingwiki.com/wiki/List_of_Xbox_Game_Pass_games`;
            try {
                const gamepassgames_html = await (await fetch(fetch_url)).text();
                return gamepassgames_html.match(regex);
            } catch (error) {
                console.error(error);
                throw "Error fecthing Xbox Game Pass games.";
            }

        }

        async function getWishlistedOnGamePass(user) {
            document.getElementById("search_button").innerHTML = "Fetching user Steam wishlist";
            const wishlist_json = await steam_wishlist(user);
            console.trace("wishlist", wishlist_json);

            document.getElementById("search_button").innerHTML = "Fetching Xbox Game Pass games";
            const game_pass_games = await pggamingwikiListOfXboxGamePassgames();
            console.trace("game pass games", game_pass_games);

            const game_pass_games_set = FuzzySet(game_pass_games);
            for (const appid in wishlist_json) {
                if (wishlist_json.hasOwnProperty(appid)) {

                    const possible_matches = game_pass_games_set.get(wishlist_json[appid]["name"], false, MIN_MATCH_SCORE);
                    if (!possible_matches) {
                        delete wishlist_json[appid];
                    }

                }
            }
            console.trace("wishlisted_on_game_pass", wishlist_json);

            return wishlist_json;

        }

        async function search() {
            let user = window.location.hash.substr(1);
            document.getElementById('steam_user').value = user;
            if (user) {
                document.getElementById("wishlisted").innerHTML = "";
                document.getElementById("errors").innerHTML = "";
                document.getElementById("info").innerHTML = "";
                const search_button_label = document.getElementById("search_button").innerHTML;
                try {
                    let wishlist_json = await getWishlistedOnGamePass(user);
                    for (const appid in wishlist_json) {
                        if (wishlist_json.hasOwnProperty(appid)) {
                            game = wishlist_json[appid];
                            const tile = document.createElement("a");
                            tile.href = `https://www.microsoft.com/en-us/search/shop/games?devicetype=pc&q=${game["name"]}`;
                            //tile.href = `https://store.steampowered.com/app/${appid}/`;
                            tile.target = "_blank";
                            const capsule = new Image();
                            capsule.src = game["capsule"];
                            tile.appendChild(capsule);
                            document.getElementById("wishlisted").appendChild(tile);
                        }
                    }
                    document.getElementById("info").innerHTML = "The following games in the user's Steam wishlist have been found to be on Xbox Game Pass :";
                } catch (error) {
                    document.getElementById("errors").innerHTML = error;
                }
                document.getElementById("search_button").innerHTML = search_button_label;
            }
        }

        window.addEventListener('hashchange', search);
        window.addEventListener("load", () => {
            document.getElementById("steam_user").addEventListener("keyup", event => {
                if (event.key !== "Enter") return;
                document.getElementById("search_button").click();
                event.preventDefault();
            });
            search();
        })

    </script>

    <style>
        * {
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            background-color: #171a21;
            color: darkgray;
        }

        main {
            text-align: center;
        }

        #wishlisted {
            padding: 2em;
        }

        #message_container {
            text-align: center;
            padding: 1em;
        }

        #message_container h2 {
            background: darkslategrey;
        }

        footer {
            text-align: center;
            padding: 3em;            
        }

        details>summary {
            border: none;
            cursor: pointer;
            list-style: none;
        }

        details>summary::-webkit-details-marker {
            display: none;
        }

        /* Style the search field */
        div.search input[type=text] {
            padding: 10px;
            font-size: 17px;
            border: 1px solid grey;
            float: left;
            width: 80%;
            background: gainsboro;
        }

        /* Style the submit button */
        div.search button {
            float: left;
            width: 20%;
            padding: 10px;
            background: darkslategrey;
            color: gainsboro;
            font-size: 17px;
            border: 1px solid grey;
            border-left: none;
            /* Prevent double borders */
            cursor: pointer;
        }

        div.search button:hover {
            background: #08497e;
        }

        /* Clear floats */
        div.search::after {
            content: "";
            clear: both;
            display: table;
        }

        a:link,
        a:visited {
            color: darkslategrey;
            text-decoration: none;
        }

        /* mouse over link */
        a:hover,
        a:active {
            color: #08497e;
        }
    </style>

</body>

</html>
